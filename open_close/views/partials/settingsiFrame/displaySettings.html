<div class="d-flex flex-column h-100" style="min-height: 0">
  <div class="flex-grow-1" style="min-height: 0; overflow: auto">
    <div class="row g-0 flex-grow-1 min-vh-100">
      <div class="col-12 col-lg-5 py-3 px-3 px-md-4 border-end-lg border-bottom border-bottom-lg-0 h-100 overflow-auto">
        <h5>{{lang.settings.iframe.displaySettings.font.label}}</h5>
        <div class="row mb-3 align-items-center">
          <div class="col">{{lang.settings.iframe.displaySettings.font.size}}</div>
          <div class="col text-end">
            <div class="input-group input-group-sm">
              <input type="text" class="form-control" id="input-font-size" value="{{ iFrame.styleSettings.font.size }}" />
              <span class="input-group-text">px</span>
            </div>
          </div>
        </div>
        <div class="row mb-3 align-items-center">
          <div class="col">{{lang.settings.iframe.displaySettings.font.weight}}</div>
          <div class="col text-end">
            <select class="form-select form-select-sm" id="font-weight-select" data-value="{{ iFrame.styleSettings.font.weight }}">
              <option value="100">100</option>
              <option value="200">200</option>
              <option value="300">300</option>
              <option value="400">400</option>
              <option value="500">500</option>
              <option value="600">600</option>
              <option value="700">700</option>
              <option value="800">800</option>
              <option value="900">900</option>
            </select>
          </div>
        </div>
        <div class="row mb-3 align-items-center">
          <div class="col">{{lang.settings.iframe.displaySettings.font.style}}</div>
          <div class="col text-end">
            <select class="form-select form-select-sm" id="font-style-select" data-value="{{ iFrame.styleSettings.font.style }}">
              <option value="normal">{{lang.settings.iframe.displaySettings.font.styleNormal}}</option>
              <option value="italic">{{lang.settings.iframe.displaySettings.font.styleItalic}}</option>
              <option value="oblique">{{lang.settings.iframe.displaySettings.font.styleOblique}}</option>
            </select>
          </div>
        </div>

        <hr class="my-4" />

        <h5>{{lang.settings.iframe.displaySettings.colors.label}}</h5>
        <div class="row mb-2 align-items-center">
          <div class="col">{{lang.settings.iframe.displaySettings.colors.fontColor}}</div>
          <div class="col text-end d-flex justify-content-end gap-2">
            <input type="text" class="form-control form-control-sm w-50" id="input-font-color" value="{{ iFrame.styleSettings.colors.fontColor.color }}" />
            <input type="color" class="form-control form-control-color" value="{{ iFrame.styleSettings.colors.fontColor.color }}" />
          </div>
        </div>
        <div class="row mb-2 align-items-center">
          <div class="col">{{lang.settings.iframe.displaySettings.colors.primaryColor}}</div>
          <div class="col text-end d-flex justify-content-end gap-2">
            <input type="text" class="form-control form-control-sm w-50" id="input-primary-color" value="{{ iFrame.styleSettings.colors.primaryColor.color }}" />
            <input type="color" class="form-control form-control-color" value="{{ iFrame.styleSettings.colors.primaryColor.color }}" />
          </div>
        </div>
        <div class="row mb-2 align-items-center">
          <div class="col">{{lang.settings.iframe.displaySettings.colors.secondaryColor}}</div>
          <div class="col text-end d-flex justify-content-end gap-2">
            <input type="text" class="form-control form-control-sm w-50" id="input-secondary-color" value="{{ iFrame.styleSettings.colors.secondaryColor.color }}" />
            <input type="color" class="form-control form-control-color" value="{{ iFrame.styleSettings.colors.secondaryColor.color }}" />
          </div>
        </div>
        <div class="row mb-2 align-items-center">
          <div class="col">{{lang.settings.iframe.displaySettings.colors.backgroundColor}}</div>
          <div class="col text-end d-flex justify-content-end gap-2">
            <input type="text" class="form-control form-control-sm w-50" id="input-background-color" value="{{ iFrame.styleSettings.colors.backgroundColor.color }}" />
            <input type="color" class="form-control form-control-color" value="{{ iFrame.styleSettings.colors.backgroundColor.color }}" />
          </div>
        </div>
        <div class="row mb-2 align-items-center">
          <div class="col">{{lang.settings.iframe.displaySettings.colors.open}}</div>
          <div class="col text-end d-flex justify-content-end gap-2">
            <input type="text" class="form-control form-control-sm w-50" id="input-opened-color" value="{{ iFrame.styleSettings.colors.openedColor.color }}" />
            <input type="color" class="form-control form-control-color" value="{{ iFrame.styleSettings.colors.openedColor.color }}" />
          </div>
        </div>
        <div class="row mb-2 align-items-center">
          <div class="col">{{lang.settings.iframe.displaySettings.colors.closed}}</div>
          <div class="col text-end d-flex justify-content-end gap-2">
            <input type="text" class="form-control form-control-sm w-50" id="input-closed-color" value="{{ iFrame.styleSettings.colors.closedColor.color }}" />
            <input type="color" class="form-control form-control-color" value="{{ iFrame.styleSettings.colors.closedColor.color }}" />
          </div>
        </div>
        <div class="row mb-4 align-items-center">
          <div class="col">{{lang.settings.iframe.displaySettings.colors.soon}}</div>
          <div class="col text-end d-flex justify-content-end gap-2">
            <input type="text" class="form-control form-control-sm w-50" id="input-soon-color" value="{{ iFrame.styleSettings.colors.soonColor.color }}" />
            <input type="color" class="form-control form-control-color" value="{{ iFrame.styleSettings.colors.soonColor.color }}" />
          </div>
        </div>

        <hr class="my-4" />

        <h5>{{lang.settings.iframe.displaySettings.border.label}}</h5>
        <div class="row mb-3 align-items-center">
          <div class="col">{{lang.settings.iframe.displaySettings.border.size}}</div>
          <div class="col text-end">
            <div class="input-group input-group-sm">
              <input type="text" class="form-control" id="input-border-width" value="{{ iFrame.styleSettings.border.width }}" />
              <span class="input-group-text">px</span>
            </div>
          </div>
        </div>
        <div class="row mb-3 align-items-center">
          <div class="col">{{lang.settings.iframe.displaySettings.border.weight}}</div>
          <div class="col text-end">
            <select class="form-select form-select-sm" id="border-weight-select" data-value="{{ iFrame.styleSettings.border.weight }}">
              <option value="100">100</option>
              <option value="200">200</option>
              <option value="300">300</option>
              <option value="400">400</option>
              <option value="500">500</option>
              <option value="600">600</option>
              <option value="700">700</option>
              <option value="800">800</option>
              <option value="900">900</option>
            </select>
          </div>
        </div>
        <div class="row mb-3 align-items-center">
          <div class="col">{{lang.settings.iframe.displaySettings.border.style}}</div>
          <div class="col text-end">
            <select class="form-select form-select-sm" id="border-style-select" data-value="{{ iFrame.styleSettings.border.style }}">
              <option value="solid">{{lang.settings.iframe.displaySettings.border.styleSolid}}</option>
              <option value="dashed">{{lang.settings.iframe.displaySettings.border.styleDashed}}</option>
              <option value="dotted">{{lang.settings.iframe.displaySettings.border.styleDotted}}</option>
            </select>
          </div>
        </div>

        <hr class="my-4" />

        <h5>{{lang.settings.iframe.displaySettings.shadow.label}}</h5>
        <div class="row mb-3 align-items-center">
          <div class="col">{{lang.settings.iframe.displaySettings.shadow.offsetX}}</div>
          <div class="col text-end">
            <div class="input-group input-group-sm">
              <input type="text" class="form-control" id="input-shadow-offset-x" value="{{ iFrame.styleSettings.shadow.offsetX }}" />
              <span class="input-group-text">px</span>
            </div>
          </div>
        </div>
        <div class="row mb-3 align-items-center">
          <div class="col">{{lang.settings.iframe.displaySettings.shadow.offsetY}}</div>
          <div class="col text-end">
            <div class="input-group input-group-sm">
              <input type="text" class="form-control" id="input-shadow-offset-y" value="{{ iFrame.styleSettings.shadow.offsetY }}" />
              <span class="input-group-text">px</span>
            </div>
          </div>
        </div>
        <div class="row mb-3 align-items-center">
          <div class="col">{{lang.settings.iframe.displaySettings.shadow.blur}}</div>
          <div class="col text-end">
            <div class="input-group input-group-sm">
              <input type="text" class="form-control" id="input-shadow-blur" value="{{ iFrame.styleSettings.shadow.blur }}" />
              <span class="input-group-text">px</span>
            </div>
          </div>
        </div>
        <div class="row mb-3 align-items-center">
          <div class="col">{{lang.settings.iframe.displaySettings.shadow.color}}</div>
          <div class="col text-end d-flex justify-content-end gap-2">
            <input type="text" class="form-control form-control-sm w-50" id="input-shadow-color" value="{{ iFrame.styleSettings.shadow.color.color }}" />
            <input type="color" class="form-control form-control-color" value="{{ iFrame.styleSettings.shadow.color.color }}" />
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-7 d-none d-lg-flex flex-column py-3 px-3 px-md-4 ds-preview" style="max-height: 900px">
        <div class="w-100 ds-preview-frame flex-grow-1" style="border: 2px solid #aaa">
          <iframe title="Vorschau" src="/{{currentLang}}/iframe/{{iFrame.userId}}?size=large" loading="lazy" class="ds-preview-iframe w-100 h-100" style="border: 0"></iframe>
        </div>
        <div class="mt-3">
          <label class="form-label fw-bold">Link</label>
          <div class="input-group">
            <input type="text" class="form-control font-monospace" id="iframe-embed-code" readonly style="font-size: 0.85rem;" />
            <button class="btn btn-outline-secondary" type="button" id="copy-iframe-code" title="Kopieren">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z" />
                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z" />
              </svg>
            </button>
          </div>
        </div>
        <div class="mt-3">
          <a href="/user_guide.pdf" download class="btn btn-outline-primary w-100">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-2" viewBox="0 0 16 16">
              <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
              <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
            </svg>
            User Guide herunterladen
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-auto pt-2 px-3 px-md-4 pb-3 border-top">
    <div id="general-feedback" class="text-center small d-none"></div>
    <div class="d-flex flex-column flex-sm-row gap-2">
      <button class="btn btn-outline-danger w-100">{{lang.settings.global.discard}}</button>
      <button class="btn btn-success w-100" id="btn-save-settings">{{lang.settings.global.save}}</button>
    </div>
  </div>

  <script>
    document.getElementById("btn-save-settings").addEventListener("click", async () => {
      // Clear previous errors
      document.querySelectorAll(".is-invalid").forEach((el) => el.classList.remove("is-invalid"));
      document.querySelectorAll(".invalid-feedback-custom").forEach((el) => el.remove());
      const generalFeedback = document.getElementById("general-feedback");
      generalFeedback.classList.add("d-none");
      generalFeedback.textContent = "";
      generalFeedback.classList.remove("text-danger", "text-success");

      // Helper to show error
      let hasError = false;
      const showError = (elementId, message) => {
        const input = document.getElementById(elementId);
        if (input) {
          input.classList.add("is-invalid");
          const feedback = document.createElement("div");
          feedback.className = "text-danger small mt-1 text-end invalid-feedback-custom";
          feedback.textContent = message;

          const container = input.closest(".col");
          if (container) {
            container.appendChild(feedback);
          } else {
            input.parentElement.appendChild(feedback);
          }
          hasError = true;
        }
      };

      // Client-side Validation
      const fontSize = document.getElementById("input-font-size").value;
      if (!fontSize || isNaN(fontSize)) showError("input-font-size", "Muss eine Zahl sein");

      const borderWidth = document.getElementById("input-border-width").value;
      if (!borderWidth || isNaN(borderWidth)) showError("input-border-width", "Muss eine Zahl sein");

      ["input-shadow-offset-x", "input-shadow-offset-y", "input-shadow-blur"].forEach((id) => {
        const val = document.getElementById(id).value;
        if (!val || isNaN(val)) showError(id, "Muss eine Zahl sein");
      });

      const colorIds = ["input-font-color", "input-primary-color", "input-secondary-color", "input-background-color", "input-opened-color", "input-closed-color", "input-soon-color", "input-shadow-color"];
      colorIds.forEach((id) => {
        const val = document.getElementById(id).value;
        if (!val || !val.startsWith("#")) showError(id, "Ungültige Farbe (Hex)");
      });

      if (hasError) {
        generalFeedback.textContent = "Bitte überprüfen Sie die Eingaben.";
        generalFeedback.classList.add("text-danger");
        generalFeedback.classList.remove("d-none");
        return;
      }

      const userId = "{{ iFrame.userId }}";
      const styleSettings = {
        font: {
          size: document.getElementById("input-font-size").value,
          weight: document.getElementById("font-weight-select").value,
          style: document.getElementById("font-style-select").value,
        },
        colors: {
          fontColor: { color: document.getElementById("input-font-color").value },
          primaryColor: { color: document.getElementById("input-primary-color").value },
          secondaryColor: { color: document.getElementById("input-secondary-color").value },
          backgroundColor: { color: document.getElementById("input-background-color").value },
          openedColor: { color: document.getElementById("input-opened-color").value },
          closedColor: { color: document.getElementById("input-closed-color").value },
          soonColor: { color: document.getElementById("input-soon-color").value },
        },
        border: {
          width: document.getElementById("input-border-width").value,
          weight: document.getElementById("border-weight-select").value,
          style: document.getElementById("border-style-select").value,
        },
        shadow: {
          offsetX: document.getElementById("input-shadow-offset-x").value,
          offsetY: document.getElementById("input-shadow-offset-y").value,
          blur: document.getElementById("input-shadow-blur").value,
          color: { color: document.getElementById("input-shadow-color").value },
        },
      };

      const fieldMap = {
        "styleSettings.font.size": "input-font-size",
        "styleSettings.font.weight": "font-weight-select",
        "styleSettings.font.style": "font-style-select",
        "styleSettings.colors.fontColor.color": "input-font-color",
        "styleSettings.colors.primaryColor.color": "input-primary-color",
        "styleSettings.colors.secondaryColor.color": "input-secondary-color",
        "styleSettings.colors.backgroundColor.color": "input-background-color",
        "styleSettings.colors.openedColor.color": "input-opened-color",
        "styleSettings.colors.closedColor.color": "input-closed-color",
        "styleSettings.colors.soonColor.color": "input-soon-color",
        "styleSettings.border.width": "input-border-width",
        "styleSettings.border.weight": "border-weight-select",
        "styleSettings.border.style": "border-style-select",
        "styleSettings.shadow.offsetX": "input-shadow-offset-x",
        "styleSettings.shadow.offsetY": "input-shadow-offset-y",
        "styleSettings.shadow.blur": "input-shadow-blur",
        "styleSettings.shadow.color.color": "input-shadow-color",
      };

      try {
        const response = await fetch(`/api/v1/users/${userId}/config`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ styleSettings }),
        });

        const data = await response.json();

        if (response.ok) {
          generalFeedback.textContent = "Einstellungen erfolgreich gespeichert!";
          generalFeedback.classList.add("text-success");
          generalFeedback.classList.remove("d-none");
          setTimeout(() => {
            generalFeedback.classList.add("d-none");
            generalFeedback.textContent = "";
          }, 3000);
        } else {
          if (data.errors) {
            let hasMappedError = false;
            data.errors.forEach((err) => {
              const inputId = fieldMap[err.field];
              if (inputId) {
                showError(inputId, err.message);
                hasMappedError = true;
              } else {
                generalFeedback.innerHTML += `<div>${err.message}</div>`;
              }
            });

            if (hasMappedError) {
              generalFeedback.textContent = "Bitte überprüfen Sie die rot markierten Felder.";
            }
            generalFeedback.classList.add("text-danger");
            generalFeedback.classList.remove("d-none");
          } else if (data.error) {
            generalFeedback.textContent = data.error;
            generalFeedback.classList.add("text-danger");
            generalFeedback.classList.remove("d-none");
          } else {
            generalFeedback.textContent = "Ein unbekannter Fehler ist aufgetreten.";
            generalFeedback.classList.add("text-danger");
            generalFeedback.classList.remove("d-none");
          }
        }
      } catch (error) {
        console.error("Error saving settings:", error);
        generalFeedback.textContent = "Ein Netzwerkfehler ist aufgetreten.";
        generalFeedback.classList.add("text-danger");
        generalFeedback.classList.remove("d-none");
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      const userId = "{{iFrame.userId}}";
      const origin = window.location.origin;
      const iframeUrl = `${origin}/iframe/${userId}?size=small`;

      const embedInput = document.getElementById("iframe-embed-code");
      if (embedInput) {
        embedInput.value = iframeUrl;
      }

      const copyBtn = document.getElementById("copy-iframe-code");
      if (copyBtn) {
        copyBtn.addEventListener("click", () => {
          if (embedInput) {
            embedInput.select();
            if (navigator.clipboard) {
              navigator.clipboard.writeText(embedInput.value).then(() => {
                const originalHtml = copyBtn.innerHTML;
                copyBtn.innerHTML = '<span class="text-success fw-bold">OK</span>';
                setTimeout(() => (copyBtn.innerHTML = originalHtml), 2000);
              });
            } else {
              document.execCommand("copy"); // Fallback
            }
          }
        });
      }
    });
  </script>
</div>
