<div id="weekplan-list" class="d-flex flex-column h-100 bg-white" style="min-height: 0;">
    <!-- Calendar Header Wrapper -->
    <div id="calendar-header-wrapper" class="d-flex border-bottom py-2" style="flex-shrink: 0; overflow-x: auto; overflow-y: hidden;">
        <div style="width: 60px; flex-shrink: 0; background: white; z-index: 30;"></div> <!-- Spacer -->
        <div class="d-flex flex-grow-1" id="calendar-header" style="min-width: 600px;">
            <!-- Day Headers generated by JS -->
        </div>
    </div>

    <!-- Calendar Body -->
    <div class="flex-grow-1 overflow-auto position-relative" id="calendar-body-container" style="min-height: 0;">
        <div class="d-flex" style="height: 1440px; position: relative;"> <!-- 24h * 60px -->
            
            <!-- Time Labels -->
            <div style="width: 60px; flex-shrink: 0; border-right: 1px solid #eee; position: sticky; left: 0; background: white; z-index: 20;" id="time-labels">
                <!-- Generated by JS -->
            </div>

            <!-- Grid -->
            <div class="d-flex flex-grow-1 position-relative" id="day-columns" style="min-width: 600px;">
                <!-- Generated by JS -->
            </div>
        </div>
    </div>
</div>

<!-- Hidden Data Store -->
<div id="weekplan-data-store" class="d-none">
    {{#if iFrame.weekPlan}}
        {{#each iFrame.weekPlan}}
        <div class="weekplan-day-data" data-day="{{this.dayAsNumber}}">
            {{#each this.openTime}}
            <div class="weekplan-time-data" data-start="{{this.start}}" data-end="{{this.end}}"></div>
            {{/each}}
        </div>
        {{/each}}
    {{/if}}
</div>

{{> settingsiFrame/weekPlanDay}}

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const userId = "{{ iFrame.userId }}";
        
        // Initial Data from DOM
        let weekPlan = [];
        const dataStore = document.getElementById('weekplan-data-store');
        if (dataStore) {
            dataStore.querySelectorAll('.weekplan-day-data').forEach(dayEl => {
                const dayAsNumber = parseInt(dayEl.getAttribute('data-day'));
                const openTime = [];
                dayEl.querySelectorAll('.weekplan-time-data').forEach(timeEl => {
                    openTime.push({
                        start: timeEl.getAttribute('data-start'),
                        end: timeEl.getAttribute('data-end')
                    });
                });
                weekPlan.push({ dayAsNumber, openTime });
            });
        }

        // Ensure we have all 7 days
        const fullWeekPlan = [];
        for (let i = 0; i <= 6; i++) {
            const existing = weekPlan.find(d => d.dayAsNumber === i);
            if (existing) {
                fullWeekPlan.push(existing);
            } else {
                fullWeekPlan.push({ dayAsNumber: i, openTime: [] });
            }
        }
        weekPlan = fullWeekPlan;

        const dayNames = ['{{lang.settings.iframe.weekplan.sunday}}', '{{lang.settings.iframe.weekplan.monday}}', '{{lang.settings.iframe.weekplan.tuesday}}', '{{lang.settings.iframe.weekplan.wednesday}}', '{{lang.settings.iframe.weekplan.thursday}}', '{{lang.settings.iframe.weekplan.friday}}', '{{lang.settings.iframe.weekplan.saturday}}'];
        // Sort: Monday (1) to Sunday (0)
        const sortedIndices = [1, 2, 3, 4, 5, 6, 0];

        const listContainer = document.getElementById('weekplan-list');
        // const itemsContainer = document.getElementById('weekplan-items'); // Removed
        const detailContainer = document.getElementById('weekplan-detail');
        
        const detailDayName = document.getElementById('detail-day-name');
        const isClosedCheckbox = document.getElementById('weekplan-is-closed');
        const timeSlotsContainer = document.getElementById('time-slots-container');
        const addSlotBtn = document.getElementById('btn-add-slot');
        const backBtn = document.getElementById('btn-back-weekplan');
        const saveBtn = document.getElementById('btn-save-weekplan');

        let currentEditDayIndex = null; // 0-6

        const timeToMinutes = (timeStr) => {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        };

        const renderList = () => {
            const headerContainer = document.getElementById('calendar-header');
            const timeLabelsContainer = document.getElementById('time-labels');
            const dayColumnsContainer = document.getElementById('day-columns');
            
            if(!headerContainer || !timeLabelsContainer || !dayColumnsContainer) return;

            headerContainer.innerHTML = '';
            timeLabelsContainer.innerHTML = '';
            dayColumnsContainer.innerHTML = '';

            const dayLabels = ['{{lang.settings.iframe.weekplan.sundayShort}}', '{{lang.settings.iframe.weekplan.mondayShort}}', '{{lang.settings.iframe.weekplan.tuesdayShort}}', '{{lang.settings.iframe.weekplan.wednesdayShort}}', '{{lang.settings.iframe.weekplan.thursdayShort}}', '{{lang.settings.iframe.weekplan.fridayShort}}', '{{lang.settings.iframe.weekplan.saturdayShort}}']; // 0=Sunday

            console.log(dayLabels)

            // 1. Render Headers (Sorted: Mo-So)
            sortedIndices.forEach(dayIndex => {
                const col = document.createElement('div');
                col.className = 'flex-grow-1 text-center fw-bold text-muted small border-end py-1';
                col.style.width = '0'; // Force equal width
                col.textContent = dayLabels[dayIndex];
                headerContainer.appendChild(col);
            });

            // 2. Render Time Labels (00:00 - 23:00)
            for (let i = 0; i < 24; i++) {
                const label = document.createElement('div');
                label.style.height = '60px';
                label.className = 'text-end pe-2 small text-muted';
                label.style.fontSize = '10px';
                label.style.transform = 'translateY(-8px)'; // Align text with grid line
                label.textContent = `${i.toString().padStart(2, '0')}:00`;
                timeLabelsContainer.appendChild(label);
            }

            // 3. Render Grid Columns and Events
            sortedIndices.forEach(dayIndex => {
                const dayData = weekPlan.find(d => d.dayAsNumber === dayIndex);
                
                const col = document.createElement('div');
                col.className = 'flex-grow-1 border-end position-relative';
                col.style.width = '0'; // Force equal width
                
                // Add horizontal grid lines
                for(let i=0; i<24; i++) {
                    const line = document.createElement('div');
                    line.style.height = '60px';
                    line.style.borderBottom = '1px solid #f0f0f0';
                    line.classList.add('grid-line'); // Marker class
                    col.appendChild(line);
                }

                // Click on column to edit
                col.onclick = (e) => {
                    // Prevent triggering if clicked on an event (event propagation)
                    if(e.target === col || e.target.classList.contains('grid-line')) {
                        openDetail(dayIndex);
                    }
                };

                // Render Events
                if (dayData && dayData.openTime && dayData.openTime.length > 0) {
                    dayData.openTime.forEach(slot => {
                        if (!slot.start || !slot.end) return;

                        const startMin = timeToMinutes(slot.start);
                        const endMin = timeToMinutes(slot.end);
                        const duration = endMin - startMin;

                        const eventEl = document.createElement('div');
                        eventEl.className = 'position-absolute rounded px-1 small text-white overflow-hidden shadow-sm';
                        eventEl.style.backgroundColor = '#4285f4'; // Google Blue
                        eventEl.style.top = `${startMin}px`; // 1 min = 1px height (since 1h = 60px)
                        eventEl.style.height = `${duration}px`;
                        eventEl.style.left = '2px';
                        eventEl.style.right = '2px';
                        eventEl.style.zIndex = '10';
                        eventEl.style.cursor = 'pointer';
                        eventEl.style.fontSize = '10px';
                        eventEl.style.lineHeight = '1.2';
                        eventEl.title = `${slot.start} - ${slot.end}`;
                        
                        eventEl.innerHTML = `
                            <div class="fw-bold">${slot.start} - ${slot.end}</div>
                        `;
                        
                        eventEl.onclick = (e) => {
                            e.stopPropagation();
                            openDetail(dayIndex);
                        };

                        col.appendChild(eventEl);
                    });
                }

                dayColumnsContainer.appendChild(col);
            });
        };

        const addTimeSlot = (start = '', end = '') => {
            const row = document.createElement('div');
            row.className = 'd-flex justify-content-center gap-3 mb-3 align-items-center time-slot-row';
            row.innerHTML = `
                <input type="time" class="form-control border-0 shadow-none bg-light text-secondary slot-start" style="width: 110px;" value="${start}" required>
                <span class="text-secondary">-</span>
                <input type="time" class="form-control border-0 shadow-none bg-light text-secondary slot-end" style="width: 110px;" value="${end}" required>
                <button type="button" class="btn-close btn-sm remove-slot" aria-label="Close"></button>
            `;
            timeSlotsContainer.appendChild(row);
            
            row.querySelector('.remove-slot').addEventListener('click', () => row.remove());
        };

        const openDetail = (dayIndex) => {
            currentEditDayIndex = dayIndex;
            const dayData = weekPlan.find(d => d.dayAsNumber === dayIndex);
            
            detailDayName.textContent = dayNames[dayIndex];
            timeSlotsContainer.innerHTML = '';
            
            const isClosed = !dayData.openTime || dayData.openTime.length === 0;
            isClosedCheckbox.checked = isClosed;
            
            if (!isClosed) {
                dayData.openTime.forEach(t => addTimeSlot(t.start, t.end));
            }
            
            toggleInputs();

            listContainer.classList.remove('d-flex');
            listContainer.classList.add('d-none');
            detailContainer.classList.remove('d-none');
            detailContainer.classList.add('d-flex');
        };

        const toggleInputs = () => {
            const isClosed = isClosedCheckbox.checked;
            addSlotBtn.disabled = isClosed;
            if (isClosed) {
                timeSlotsContainer.innerHTML = '';
                addSlotBtn.style.opacity = '0.5';
            } else {
                addSlotBtn.style.opacity = '1';
                if (timeSlotsContainer.children.length === 0) {
                    addTimeSlot(); // Add one empty slot if opening
                }
            }
        };

        isClosedCheckbox.addEventListener('change', toggleInputs);
        addSlotBtn.addEventListener('click', () => addTimeSlot());

        backBtn.addEventListener('click', () => {
            detailContainer.classList.remove('d-flex');
            detailContainer.classList.add('d-none');
            listContainer.classList.remove('d-none');
            listContainer.classList.add('d-flex');
        });

        saveBtn.addEventListener('click', async () => {
            const newOpenTime = [];
            if (!isClosedCheckbox.checked) {
                document.querySelectorAll('.time-slot-row').forEach(row => {
                    const start = row.querySelector('.slot-start').value;
                    const end = row.querySelector('.slot-end').value;
                    if (start && end) {
                        newOpenTime.push({ start, end });
                    }
                });
            }

            // Update local state
            const dayIndex = weekPlan.findIndex(d => d.dayAsNumber === currentEditDayIndex);
            if (dayIndex !== -1) {
                weekPlan[dayIndex].openTime = newOpenTime;
            }

            // Save to server
            try {
                const response = await fetch(`/api/v1/users/${userId}/config`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ weekPlan: weekPlan })
                });

                if (response.ok) {
                    renderList();
                    backBtn.click();
                } else {
                    alert('Fehler beim Speichern');
                }
            } catch (error) {
                console.error(error);
                alert('Netzwerkfehler');
            }
        });

        renderList();

        // Sync Scroll
        const headerWrapper = document.getElementById('calendar-header-wrapper');
        const bodyContainer = document.getElementById('calendar-body-container');
        
        if (headerWrapper && bodyContainer) {
            bodyContainer.addEventListener('scroll', () => {
                headerWrapper.scrollLeft = bodyContainer.scrollLeft;
            });
        }
    });
</script>
